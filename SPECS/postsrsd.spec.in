%bcond_with apparmor
%bcond_with selinux

%define init systemd
%define postsrsd_user nobody
%define chroot_dir /var/lib/postsrsd

Name: postsrsd		
Version:  %VERSION%
Release:	%RELEASE%%{?dist}
Summary:	SRS daemon for Postfix

Group:		System Environment/Daemons
License:	GPL-2.0
URL:		  https://github.com/roehling/postsrsd
Source0:	https://github.com/roehling/postsrsd/archive/postsrsd-%{version}.tar.bz2

BuildRequires: cmake	
Requires:	postfix, systemd, libasan, libubsan

%description 
PostSRSd provides the Sender Rewriting Scheme (SRS) via TCP-based lookup tables 
for Postfix. SRS is needed if your mail server acts as forwarder.

%prep
%setup -q

%build
[[ -z $RPM_ARCH ]] && export RPM_ARCH=$(uname -m)
export RPM_PACKAGE_RELEASE=%{release} RPM_PACKAGE_VERSION=%{version} RPM_PACKAGE_NAME=%{name}

BARGS="-DCMAKE_INSTALL_PREFIX=/usr -DCHROOT_DIR=%{chroot_dir}"
%if %{with apparmor}
	BARGS="${BARGS} -DUSE_APPARMOR=ON"
%endif
%if %{with selinux}
	BARGS="${BARGS} -DUSE_SELINUX=ON"
%endif
mkdir _build && cd _build
%cmake .. ${BARGS} -DINIT_FLAVOR=%{init}
cd redhat-linux-build
%make_build


%install
cd _build/redhat-linux-build
%make_install
cp $RPM_BUILD_ROOT/%{_docdir}/postsrsd/postsrsd.conf $RPM_BUILD_ROOT/%{_sysconfdir}/postsrsd.conf

%check
ctest -V %{?_smp_mflags}

%files
%defattr(0644, root, root)
%attr(0600, %{postsrsd_user}, root) %{_sysconfdir}/postsrsd.secret
%config(noreplace) %{_sysconfdir}/postsrsd.conf
%{_unitdir}/postsrsd.service
%{_sysusersdir}/postsrsd.conf
%attr(0755, root, root) %{chroot_dir}
%attr(0755, root, root) %{_sbindir}/postsrsd

%doc
%defattr(0644, root, root)
%dir %attr(0755, root, root) %{_docdir}/postsrsd
%{_docdir}/postsrsd/postsrsd.conf

%posttrans
/bin/systemctl try-restar postsrsd.service >/dev/null 2>&1 || :

%changelog
* Mon Aug 11 2025 Matt Saladna <matt@apisnetworks.com> - 2.0.11-1
- Rebuild for RHEL9/10
